<!DOCTYPE html>
<html>
  <head>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/color/jquery.color-2.2.0.min.js" integrity="sha256-aSe2ZC5QeunlL/w/7PsVKmV+fa0eDbmybn/ptsKHR6I=" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="katex-dist/katex.min.css">
    <script src="katex-dist/katex.min.js"></script>
    <script src="_build/default/src/ora.bc.js"></script>
    <script>
      var initial_form = "(\\A [x] \\E [y] r (f x) y) & (\\A [z] r (f j) z => p (f z)) => \\E [u] p (f u)";
      // var initial_form = "\\E [x, y, z] r (f x) (g x z) => r (f (f y)) (g (f y) (g x z))";

      const macros = {
          "\\o": "\\mathsf{o}",
          "\\i": "\\mathsf{i}",
      };

      const katex_options = {
          trust: true,
          output: 'html',
          strict: false,
          macros
      }

      const formLink = {
          src: null,
          dest: null
      };

      function findPath(elem) {
          var path = [];
          var outputDiv = $('#output');
          while (elem && !$(elem).is(outputDiv)) {
              if ($(elem).attr('id')) {
                  var beforeCount = $(elem).prevAll('.enclosing').length;
                  var afterCount  = $(elem).nextAll('.enclosing').length;
                  if (beforeCount === 0)
                      path.unshift(afterCount === 0 ? 'D' : 'L');
                  else
                      path.unshift('R');
                  // console.log(path);
              }
              elem = $(elem).parent();
          }
          path.shift(); // remove the last 'D'
          // console.log(path);
          return path.join('');
      }

      function clearLinks() {
          formLink.src = null;
          formLink.dest = null;
          $('#output .enclosing').removeClass('f-src');
          $('#output .enclosing').removeClass('f-dest');
      }

      function linkSubformula(elem) {
          if (formLink.src) {
              if (formLink.dest || $(elem).is(formLink.src)) {
                  // do nothing
              } else {
                  formLink.dest = elem;
                  $(elem).addClass('f-dest');
                  // console.log('dest: ' + findPath(elem));
                  // $('#destId').text(findPath(elem));
                  var res = profint.makeLink(findPath(formLink.src),
                                             findPath(formLink.dest));
                  if (res) renderFormula();
                  else {
                      console.log('link failed');
                      clearLinks();
                      $('#output').css({
                          'background-color': 'red'
                      }).animate({
                          'background-color': 'white'
                      }, 'fast');
                  }
              }
          } else {
              formLink.src = elem;
              $(elem).addClass('f-src');
              // console.log('src: ' + findPath(elem));
              // $('#srcId').text(findPath(elem));
          }
      }

      function contractSubformula(elem) {
          var res = profint.doContraction(findPath(elem));
          if (res) renderFormula();
          else {
              console.log('contaction failed');
          }
      }

      function weakenSubformula(elem) {
          var res = profint.doWeakening(findPath(elem));
          if (res) renderFormula();
          else {
              console.log('weakening failed');
          }
      }

      function substituteWitness(elem) {
          var res = profint.doWitness(findPath(elem));
          if (res) renderFormula();
          else {
              console.log('witness failed');
          }
      }

      function renderFormula() {
          clearLinks();
          $('#output').html(function(){
              const expr = profint.formulaHTML();
              // console.log(expr);
              return katex.renderToString(expr, katex_options);
          });
          $('#output .enclosing').on("click", function(ev){
              // console.log('clicked: ' + $(this).attr('id'));
              if (ev.ctrlKey) contractSubformula(this);
              else if (ev.altKey) weakenSubformula(this);
              else if (ev.shiftKey) substituteWitness(this);
              else linkSubformula(this);
              ev.stopPropagation();
          });
          $("#output .enclosing").mouseover(function(ev) {
              $('#output .enclosing').removeClass('hl-range');
              $(this).addClass('hl-range');
              // $("span.enclosing").css({"border-bottom": "0"});
              // $(this).css({"border-bottom": "3px solid red"});
              ev.stopPropagation();
          });
          $("#output .enclosing").mouseout(function(ev) {
              $(this).removeClass('hl-range');
              // $("span.enclosing").css({"border-bottom": "0"});
          });
          $('#history').html(function(){
              const expr = profint.historyHTML();
              return katex.renderToString(expr, katex_options);
          });
          $('#doUndo').prop('disabled', profint.countHistory() <= 0);
          $('#future').html(function(){
              const expr = profint.futureHTML();
              return katex.renderToString(expr, katex_options);
          });
          $('#doRedo').prop('disabled', profint.countFuture() <= 0);
      }
      
      function changeFormula(text) {
          var res = profint.formulaChange(text);
          if (res) renderFormula();
          else {
              // console.log('formChange() failed');
              $('#output').css({'background-color': 'red'});
              $('#output').animate({'background-color': 'white'}, 'slow');
          }
      }

      $(document).ready(function(){
          profint.signatureChange(document.sigEditor.getValue());
          if (profint.startup()) renderFormula();
          else changeFormula(initial_form);
      });
    </script>
    <style>
      body {
          padding-left: 40px;
          padding-top: 40px;
      }
      #signature {
          margin: 0;
          position: fixed;
          bottom: 0;
          left: 0;
          right: 0;
      }
      #output {margin-top: 10px; font-size: 300%;}
      #output .enclosing {border-bottom: 0;}
      #output .hl-range {border-bottom: 3px solid red;}
      .f-src {background-color: #f2bf88;}
      .f-dest {background-color: #9cc3f0;}
      #history { margin-top: 10px; font-size: 150%; }
      #future { margin-top: 10px; margin-bottom: 10px; font-size: 150%; }
    </style>
  </head>
  <body>
    <pre id="signature">p : \i -> \o.
q : \i -> \i -> \o.

f : \i -> \i.
g : \i -> \i -> \i.

j, k : \i.

a, b, c : \o.

p, q : \i -> \o.
r : \i -> \i -> \o.</pre>
    <script src="dist-ace/src-noconflict/ace.js"></script>
    <script>
      var sigEditor = ace.edit("signature");
      sigEditor.setTheme("ace/theme/twilight");
      sigEditor.setOptions({
          minLines: 5,
          maxLines: 20,
          showLineNumbers: false,
          showGutter: true,
      });
      document.sigEditor = sigEditor;
      sigEditor.on("change", function(e) {
          var res = profint.signatureChange(sigEditor.getValue());
          if (!res)
              $('#signature').css({'border': '2px solid red'});
          else
              $('#signature').css({'border': 'none'});
      });
      // sigEditor.session.setMode("ace/mode/javascript");
    </script>

    <button id="changeFormula">Change Formula</button>
    <button id="doUndo">&nbsp;◁&nbsp;</button>
    <button id="doRedo">&nbsp;▷&nbsp;</button>

    <script>
      $('#changeFormula').click(function(){
          var text = prompt('Enter the new formula');
          changeFormula(text);
      });
      $('#doUndo').click(function(){
          var res = profint.doUndo();
          if (res) renderFormula();
          else console.log('undo failed');
      });
      $('#doRedo').click(function(){
          var res = profint.doRedo();
          if (res) renderFormula();
          else console.log('redo failed');
      });
    </script>

    <div id="future">
      ...
    </div>

    <div id="output">
      ...
    </div>

    <div id="history">
      ...
    </div>
  </body>
</html>
