<!DOCTYPE html>
<html>
  <head>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="katex-dist/katex.min.css">
    <script src="katex-dist/katex.min.js"></script>
    <style>
      .formSource {
          background-color: #f2bf88;
      }
      .formSink {
          background-color: #9cc3f0;
      }
    </style>
    <script>
      const formLink = {
          src: null,
          dest: null
      };
      function findPath(elem) {
          var path = [];
          var outputDiv = $('#output');
          while (elem && $(elem).attr('id') && !$(elem).is(outputDiv)) {
              var parent = $(elem).parent();
              var beforeCount = $(elem).prevAll('.enclosing').length;
              var afterCount  = $(elem).nextAll('.enclosing').length;
              if (beforeCount === 0)
                  path.unshift(afterCount === 0 ? 'D' : 'L');
              else
                  path.unshift('R');
              // console.log(path);
              elem = $(elem).parent();
          }
          path.shift(); // remove the last 'D'
          return path;
      }
      function clearLinks() {
          formLink.src = null;
          formLink.dest = null;
          $('#output span.enclosing').removeClass('formSink');
          $('#output span.enclosing').removeClass('formSource');
          $('#srcId').text('...');
          $('#destId').text('...');
      }
      function clickSubformula(elem) {
          if (formLink.src) {
              if (formLink.dest) {
                  // do nothing
              } else {
                  formLink.dest = elem;
                  $(elem).addClass('formSink');
                  $('#destId').text(findPath(elem));
              }
          } else {
              formLink.src = elem;
              $(elem).addClass('formSource');
              $('#srcId').text(findPath(elem));
          }
      }
      $(document).ready(function(){
          $('#clearLinks').click(clearLinks);
      });
    </script>
  </head>
  <body>
    <div id='output'>...</div>
    <table>
      <tr><td colspan="2"><button id="clearLinks">clear links</button></td></tr>
      <tr><td>Source:&nbsp;</td><td id='srcId'>...</td></tr>
      <tr><td>Destination:&nbsp;</td><td id='destId'>...</td></tr>
    </table>

    <script>
      $('#output').html(function(){
          const macros = {
              "\\o": "\\mathsf{o}",
              "\\i": "\\mathsf{i}",
          };
          const expr =
"\\htmlId{7}{(\\htmlId{6}{\\exists{x{:}\\i}.\\,\\htmlId{5}{p{\\cdot}[x]}})\\supset(\\htmlId{4}{\\exists{y{:}\\i}.\\,\\htmlId{3}{\\htmlId{2}{p{\\cdot}[y]}\\supset\\htmlId{1}{c}}})}";
          return katex.renderToString(expr, {
              trust: true,
              macros
          }) ;
      });
      $("#output span.enclosing").on("mousedown", function(ev) {
          clickSubformula($(this));
          ev.stopPropagation();
      });
      $("#output span.enclosing").mouseover(function(ev) {
          $("span.enclosing").css({"border-bottom": "0"});
          $(this).css({"border-bottom": "3px solid red"});
          ev.stopPropagation();
      });
      $("#output span.enclosing").mouseout(function(ev) {
          $("span.enclosing").css({"border-bottom": "0"});
      });
    </script>
  </body>
</html>
